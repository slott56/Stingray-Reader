<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>10.2.2. COBOL Loader Module – Parse COBOL Source to Load a Schema &mdash; The Stingray Schema-Based File Reader</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '4.4.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="The Stingray Schema-Based File Reader" href="index.html" />
    <link rel="up" title="10. The COBOL Package" href="cobol.html" />
    <link rel="next" title="10.2.3. COBOL Definitions Module – Handle COBOL DDE’s" href="cobol_defs.html" />
    <link rel="prev" title="10.2.1. COBOL Package – Extend Schema to Handle EBCDIC" href="cobol_init.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="cobol_defs.html" title="10.2.3. COBOL Definitions Module – Handle COBOL DDE’s"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="cobol_init.html" title="10.2.1. COBOL Package – Extend Schema to Handle EBCDIC"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">The Stingray Schema-Based File Reader</a> &raquo;</li>
          <li><a href="cobol.html" accesskey="U">10. The COBOL Package</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="module-cobol.loader">
<span id="cobol-loader-module-parse-cobol-source-to-load-a-schema"></span><span id="cobol-loader"></span><h1>10.2.2. COBOL Loader Module &#8211; Parse COBOL Source to Load a Schema<a class="headerlink" href="#module-cobol.loader" title="Permalink to this headline">¶</a></h1>
<p>Parsing a spreadsheet schema is relatively easy: see <a class="reference internal" href="schema_loader.html#schema-loader"><em>Schema Loader Module &#8211; Load Embedded or External Schema</em></a>.
Parsing a COBOL schema, however, is a bit more complex.</p>
<p>Two of the three problems associated with COBOL are solved in  <a class="reference internal" href="cobol.html#cobol"><em>The COBOL Package</em></a>.
What remains is parsing the COBOL source to extract a schema.</p>
<p>A new <a class="reference internal" href="schema_loader.html#schema.loader.ExternalSchemaLoader" title="schema.loader.ExternalSchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader</span></tt></a> subclass is required
to parse the DDE sublanguage of COBOL.   This loader will build the hierarchical
DDE from the COBOL source, decorate this with size and offset information,
then flatten it into a simple <a class="reference internal" href="schema.html#schema.Schema" title="schema.Schema"><tt class="xref py py-class docutils literal"><span class="pre">schema.Schema</span></tt></a> instance.</p>
<div class="section" id="load-a-schema-use-case">
<h2>10.2.2.1. Load A Schema Use Case<a class="headerlink" href="#load-a-schema-use-case" title="Permalink to this headline">¶</a></h2>
<p>The goal of use case is to load a schema encoded in COBOL.  This breaks down
into two steps.</p>
<ol class="arabic simple">
<li>Parse the COBOL &#8220;copybook&#8221; source file.</li>
<li>Produce a <a class="reference internal" href="schema.html#schema.Schema" title="schema.Schema"><tt class="xref py py-mod docutils literal"><span class="pre">schema.Schema</span></tt></a> instance that can be used to access data
in a COBOL file.</li>
</ol>
<p>Ideally, this will look something like the following.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;sample/zipcty.cob&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cobol</span><span class="p">:</span>
    <span class="n">schema</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">COBOLSchemaLoader</span><span class="p">(</span> <span class="n">cobol</span> <span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="c">#pprint.pprint( schema )</span>
<span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="s">&#39;sample/zipcty1&#39;</span><span class="p">,</span> <span class="s">&#39;sample/zipcty2&#39;</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">Character_File</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="p">)</span> <span class="k">as</span> <span class="n">wb</span><span class="p">:</span>
        <span class="n">sheet</span><span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
        <span class="n">counts</span><span class="o">=</span> <span class="n">process_sheet</span><span class="p">(</span> <span class="n">sheet</span> <span class="p">)</span>
        <span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span> <span class="n">counts</span> <span class="p">)</span>
</pre></div>
</div>
<p>Step 1 is to open the COBOL DDE &#8220;copybook&#8221; file, <tt class="file docutils literal"><span class="pre">zipcty.cob</span></tt> that defines the layout.
We build the schema using a <a class="reference internal" href="#cobol.loader.COBOLSchemaLoader" title="cobol.loader.COBOLSchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">cobol.loader.COBOLSchemaLoader</span></tt></a>.</p>
<p>Step 2 is to open the source data, <tt class="file docutils literal"><span class="pre">zipcty1</span></tt> with the data.
We&#8217;ve made a <a class="reference internal" href="sheet.html#sheet.Sheet" title="sheet.Sheet"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Sheet</span></tt></a> from the file: the sheet&#8217;s name is <tt class="docutils literal"><span class="pre">&quot;zipcty1&quot;</span></tt>,
the the schema is the external provided when we opened the <a class="reference internal" href="cobol_init.html#cobol.Character_File" title="cobol.Character_File"><tt class="xref py py-class docutils literal"><span class="pre">cobol.Character_File</span></tt></a>.</p>
<p>Once the sheet is available, we can then run some function, <tt class="docutils literal"><span class="pre">process_sheet</span></tt>, on the
sheet. This will use the <a class="reference internal" href="sheet.html#sheet.Sheet" title="sheet.Sheet"><tt class="xref py py-class docutils literal"><span class="pre">sheet.Sheet</span></tt></a> API to process rows and cells of the
sheet. Each piece of source data is loaded as a kind of <a class="reference internal" href="cell.html#cell.Cell" title="cell.Cell"><tt class="xref py py-class docutils literal"><span class="pre">cell.Cell</span></tt></a>.</p>
<p>We can then use appropriate conversions to recover Python objects.
This leads us to the second use case.</p>
<p>Here&#8217;s what a <tt class="docutils literal"><span class="pre">process_sheet()</span></tt> function might look like in this context.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">process_sheet</span><span class="p">(</span> <span class="n">sheet</span> <span class="p">):</span>
    <span class="n">schema_dict</span><span class="o">=</span> <span class="nb">dict</span><span class="p">(</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">schema</span> <span class="p">)</span>
    <span class="n">schema_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span> <span class="nb">dict</span><span class="p">(</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">schema</span> <span class="p">)</span> <span class="p">)</span>

    <span class="n">counts</span><span class="o">=</span> <span class="p">{</span> <span class="s">&#39;read&#39;</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span>

    <span class="n">row_iter</span><span class="o">=</span> <span class="n">sheet</span><span class="o">.</span><span class="n">rows</span><span class="p">()</span>
    <span class="n">header</span><span class="o">=</span> <span class="n">header_builder</span><span class="p">(</span> <span class="nb">next</span><span class="p">(</span><span class="n">row_iter</span><span class="p">),</span> <span class="n">schema_dict</span> <span class="p">)</span>
    <span class="k">print</span><span class="p">(</span> <span class="n">header</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">row_iter</span><span class="p">:</span>
        <span class="n">detail</span><span class="o">=</span> <span class="n">row_builder</span><span class="p">(</span> <span class="n">row</span><span class="p">,</span> <span class="n">schema_dict</span> <span class="p">)</span>
        <span class="k">print</span><span class="p">(</span> <span class="n">detail</span> <span class="p">)</span>
        <span class="n">counts</span><span class="p">[</span><span class="s">&#39;read&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">counts</span>
</pre></div>
</div>
<p>First, we&#8217;ve build two versions of the schema, indexed by low-level item name
and the full path to an item. In some cases, the low-level DDE items are unique,
and the paths are not required. In other cases, the paths are required.</p>
<p>We&#8217;ve initialized some record counts, always a good practice.</p>
<p>We&#8217;ve fetched the first record and used some function named <tt class="docutils literal"><span class="pre">header_builder()</span></tt> to
transform the record into a header, which we print.</p>
<p>We&#8217;ve fetched all other records and used a function named <tt class="docutils literal"><span class="pre">row_builder()</span></tt> to
transform every following record into details, which we also print.</p>
<p>This shows a physical head-tail processing. In some cases, there&#8217;s an attribute
which differentiates headers, body and trailers.</p>
</div>
<div class="section" id="use-a-schema-use-case">
<h2>10.2.2.2. Use A Schema Use Case<a class="headerlink" href="#use-a-schema-use-case" title="Permalink to this headline">¶</a></h2>
<p>The goal of this use case is to build usable Python objects from the source file data.</p>
<p>For each row, there&#8217;s a two-step operation.</p>
<ol class="arabic simple">
<li>Access elements of each row using the COBOL DDE structure.</li>
<li>Build Python objects from the Cells found in the row.</li>
</ol>
<p>Generally, we must use lazy evaluation as shown in this example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">header_builder</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">file_version_year</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;FILE-VERSION-YEAR&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">file_version_month</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;FILE-VERSION-MONTH&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">copyright_symbol</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;COPYRIGHT-SYMBOL&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">tape_sequence_no</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;TAPE-SEQUENCE-NO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">row_builder</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">zip_code</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;ZIP-CODE&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">update_key_no</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;UPDATE-KEY-NO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">low_sector</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;COUNTY-CROSS-REFERENCE-RECORD.ZIP-ADD-ON-RANGE.ZIP-ADD-ON-LOW-NO.ZIP-SECTOR-NO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">low_segment</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;COUNTY-CROSS-REFERENCE-RECORD.ZIP-ADD-ON-RANGE.ZIP-ADD-ON-LOW-NO.ZIP-SEGMENT-NO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">high_sector</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;COUNTY-CROSS-REFERENCE-RECORD.ZIP-ADD-ON-RANGE.ZIP-ADD-ON-HIGH-NO.ZIP-SECTOR-NO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">high_segment</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;COUNTY-CROSS-REFERENCE-RECORD.ZIP-ADD-ON-RANGE.ZIP-ADD-ON-HIGH-NO.ZIP-SEGMENT-NO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">state_abbrev</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;STATE-ABBREV&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">county_no</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;COUNTY-NO&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
        <span class="n">county_name</span><span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cell</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s">&#39;COUNTY-NAME&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">to_str</span><span class="p">(),</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>Each cell is accessed in a three-step operation.</p>
<ol class="arabic simple">
<li>Get the schema information via <tt class="docutils literal"><span class="pre">schema['shortname']</span></tt> or <tt class="docutils literal"><span class="pre">schema['full.path.name']</span></tt></li>
<li>Build the <tt class="docutils literal"><span class="pre">Cell</span></tt> using the schema information via <tt class="docutils literal"><span class="pre">row.cell(...)</span></tt>.</li>
<li>Convert the <tt class="docutils literal"><span class="pre">Cell</span></tt> to our target type via <tt class="docutils literal"><span class="pre">...to_str()</span></tt>.</li>
</ol>
<p>We <strong>must</strong> do this in steps because the COBOL records may have invalid fields,
or <tt class="docutils literal"><span class="pre">REDEFINES</span></tt> or <tt class="docutils literal"><span class="pre">OCCURS</span> <span class="pre">DEPENDING</span> <span class="pre">ON</span></tt> clauses.</p>
<p>If we want to build higher-level, pure Python objects associated with some
application, we&#8217;ll do this.</p>
<pre class="literal-block">
def build_object(row, schema):
    return Object( **row_builder(row, schema) )
</pre>
<p>We&#8217;ll simply assure that the row&#8217;s dictionary keys are the proper keyword arguments for
our application class definitions.</p>
<p>When we have indexing to do, this is only slightly more complex. The resulting object
will be a list-of-list structure, and we apply the indexes in the order from the original
DDE definition to pick apart the lists.</p>
</div>
<div class="section" id="extensions-and-special-cases">
<h2>10.2.2.3. Extensions and Special Cases<a class="headerlink" href="#extensions-and-special-cases" title="Permalink to this headline">¶</a></h2>
<p>The typical use cases is something like the following:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;sample/zipcty.cob&quot;</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">cobol</span><span class="p">:</span>
    <span class="n">schema</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">COBOLSchemaLoader</span><span class="p">(</span> <span class="n">cobol</span> <span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
<span class="k">with</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">Character_File</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="p">)</span> <span class="k">as</span> <span class="n">wb</span><span class="p">:</span>
    <span class="n">sheet</span><span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">sheet</span><span class="p">(</span> <span class="n">filename</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">sheet</span><span class="o">.</span><span class="n">rows</span><span class="p">():</span>
        <span class="n">dump</span><span class="p">(</span> <span class="n">schema</span><span class="p">,</span> <span class="n">row</span> <span class="p">)</span>
</pre></div>
</div>
<p>This will use the default parsing to create a schema from a DDA and process a
file, dumping each record.</p>
<p>There are two common extension:</p>
<ul class="simple">
<li>new lexical scanner, and</li>
<li>different ODO handling.</li>
</ul>
<p>To change lexical scanners, we create a new subclass of the parser.</p>
<p>We use this by subclassing <tt class="xref py py-class docutils literal"><span class="pre">cobol.COBOLSchemaLoader</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MySchemaLoader</span><span class="p">(</span> <span class="n">cobol</span><span class="o">.</span><span class="n">COBOLSchemaLoader</span> <span class="p">):</span>
    <span class="n">lexer_class</span><span class="o">=</span> <span class="n">cobol</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">Lexer_Long_Lines</span>
</pre></div>
</div>
<p>This will use a different lexical scanner when parsing a DDE file.</p>
<p>We may also need to change the record factory. This involves two separate extensions.
We must extend the <a class="reference internal" href="#cobol.loader.RecordFactory" title="cobol.loader.RecordFactory"><tt class="xref py py-class docutils literal"><span class="pre">cobol.loader.RecordFactory</span></tt></a> to change the features.
Then we can extend <a class="reference internal" href="#cobol.loader.COBOLSchemaLoader" title="cobol.loader.COBOLSchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">cobol.loader.COBOLSchemaLoader</span></tt></a> to use this record
factory.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ExtendedRecordFactory</span><span class="p">(</span> <span class="n">cobol</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">RecordFactory</span> <span class="p">):</span>
    <span class="n">occurs_dependingon_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">OccursDependingOnLimit</span>
    <span class="c">#Default is occurs_dependingon_class= stingray.cobol.defs.OccursDependingOn</span>

<span class="k">class</span> <span class="nc">MySchemaLoader</span><span class="p">(</span> <span class="n">cobol</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">COBOLSchemaLoader</span> <span class="p">):</span>
    <span class="n">record_factory_class</span><span class="o">=</span> <span class="n">ExtendedRecordFactory</span>
</pre></div>
</div>
<p>This will use a different record factory to elaborate the details of the DDE.</p>
</div>
<div class="section" id="design">
<h2>10.2.2.4. Design<a class="headerlink" href="#design" title="Permalink to this headline">¶</a></h2>
<p>A DDE contains a recursive definition of a COBOL group-level DDE.
There are two basic species of COBOL DDE&#8217;s: elemetary items, which have a <tt class="docutils literal"><span class="pre">PICTURE</span></tt> clause,
and group-level items, which contain lower-level items.  There are several optional
features of every DDE, including an <tt class="docutils literal"><span class="pre">OCCURS</span></tt> clause and a <tt class="docutils literal"><span class="pre">REDEFINES</span></tt> clause.
In addition to the required picture clause, elementary items have an optional <tt class="docutils literal"><span class="pre">USAGE</span></tt> clause,
and optional <tt class="docutils literal"><span class="pre">SIGN</span></tt> clause.</p>
<p>The <tt class="docutils literal"><span class="pre">PICTURE</span></tt> clause specifies how to interpret a sequence of bytes.  The picture
clause interacts with the optional <tt class="docutils literal"><span class="pre">USAGE</span></tt> clause, <tt class="docutils literal"><span class="pre">SIGN</span></tt> clause and <tt class="docutils literal"><span class="pre">SYNCHRONIZED</span></tt> clause
to fully define the encoding.  The picture clause uses a complex format of code characters
to define either individual character bytes (when the usage is display) or pairs of decimal digit bytes
(when the usage is <tt class="docutils literal"><span class="pre">COMP-3</span></tt>).</p>
<p>The <tt class="docutils literal"><span class="pre">OCCURS</span></tt> clause specifies an array of elements.  If the occurs clause appears
on a group level item, the sub-record is repeated.  If the occurs clause appears
on an elementary item, that item is repeated.</p>
<p>An <strong>occurs depending on</strong> (ODO) makes the positions of each field dependent on actual
data present in the record. This is a rare, but necessary complication.</p>
<p>The <tt class="docutils literal"><span class="pre">REDEFINES</span></tt> clause defines an alias for input bytes.  When some field <em>R</em> redefines
a previously defined field <em>F</em>, the storage bytes are used for both <em>R</em> and <em>F</em>.
The record structure itself does not provide a way to disambiguate the interpretation of the bytes.
Program logic must be examined to determine the conditions under which each interpretation is valid.
It&#8217;s entirely possible either interpretation has invalid fields.</p>
<div class="section" id="dde-class">
<h3>10.2.2.4.1. DDE Class<a class="headerlink" href="#dde-class" title="Permalink to this headline">¶</a></h3>
<p>The parent class, <tt class="xref py py-class docutils literal"><span class="pre">DDE</span></tt>, defines the features of a group-level item.  It supports
the occurs and redefines features.  It can contain a number of DDE items.
The leaves of the tree define the features of an elementary item.</p>
<p>We could have a class hierarchy with group and elementary subclasses.
The group level item could have a container for lower level items.
The elementary class definition <em>could</em> add support for the picture clause, but remove
the container for lower-level items.</p>
<p>On balance, it seems simpler to have one generic DDE node class and use
optional fields than to create a proper subclass.
There isn&#8217;t a <em>good</em> reason for this.   An <strong>if</strong>
statement to look for an optional picture-clause is fairly rare.</p>
<p>The various optional clauses are handled using a variety of design patterns.
The usage information, for instance, is used to create a <strong>Strategy</strong> object
that is used to extract a field from a record&#8217;s bytes.</p>
<p>The redefines information is used to create a <strong>Strategy</strong> object that
computes the offset to a field.  There are two variant strategies: locate the basis
field and use that field&#8217;s offset or use the end of the previous element as
the offset.</p>
<p>This is further compounded by the Occurs Depending On (ODO) calculation
which cannot be done statically or eagerly, but must be done dynamically and lazily based on
live data.</p>
</div>
<div class="section" id="dde-post-processing">
<h3>10.2.2.4.2. DDE Post-processing<a class="headerlink" href="#dde-post-processing" title="Permalink to this headline">¶</a></h3>
<p>We have a number of functions to traverse a DDE structure to write
reports on the structure. The DDE has an <tt class="docutils literal"><span class="pre">__iter__()</span></tt> method which
provides a complete pre-order depth-first traversal of the record
structure.</p>
<p>Here are some functions which traverse the entire DDE structure.</p>
<ul class="simple">
<li><a class="reference internal" href="cobol_defs.html#cobol.defs.report" title="cobol.defs.report"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.report()</span></tt></a> reports on the DDE structure.</li>
<li><a class="reference internal" href="cobol_defs.html#cobol.defs.source" title="cobol.defs.source"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.source()</span></tt></a> shows canonical source.</li>
<li><a class="reference internal" href="cobol_defs.html#cobol.defs.search" title="cobol.defs.search"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.search()</span></tt></a> locates a name in DDE structure.</li>
<li><a class="reference internal" href="cobol_defs.html#cobol.defs.resolver" title="cobol.defs.resolver"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.resolver()</span></tt></a> does name resolution throughout the DDE structure.</li>
<li><a class="reference internal" href="cobol_defs.html#cobol.defs.setDimensionality" title="cobol.defs.setDimensionality"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.setDimensionality()</span></tt></a> walks up the hierarchy from each node to compute
the net occurrences based on all parent OCCURS clauses.</li>
</ul>
<p>Once there is data available, we have these additional functions.</p>
<ul class="simple">
<li><a class="reference internal" href="cobol_defs.html#cobol.defs.setSizeAndOffset" title="cobol.defs.setSizeAndOffset"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.setSizeAndOffset()</span></tt></a> computes the offset and size of each element.</li>
<li><a class="reference internal" href="cobol_init.html#cobol.dump" title="cobol.dump"><tt class="xref py py-func docutils literal"><span class="pre">cobol.dump()</span></tt></a> dumps a record showing the original DDE and the values.</li>
</ul>
<p>Note that <a class="reference internal" href="cobol_defs.html#cobol.defs.setSizeAndOffset" title="cobol.defs.setSizeAndOffset"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.setSizeAndOffset()</span></tt></a> is recursive, not iterative.
It needs to manage subtotals based on ascent and descent in the hierarchy.</p>
</div>
<div class="section" id="dde-parser">
<h3>10.2.2.4.3. DDE Parser<a class="headerlink" href="#dde-parser" title="Permalink to this headline">¶</a></h3>
<p>A <a class="reference internal" href="#cobol.loader.RecordFactory" title="cobol.loader.RecordFactory"><tt class="xref py py-class docutils literal"><span class="pre">cobol.loader.RecordFactory</span></tt></a> object reads a file of text and either creates a
DDE or raises an exception. If the text is a valid COBOL record
definition, a DDE is created.  If there are syntax errors, an exception
is raised.</p>
<p>The <a class="reference internal" href="#cobol.loader.RecordFactory" title="cobol.loader.RecordFactory"><tt class="xref py py-class docutils literal"><span class="pre">cobol.loader.RecordFactory</span></tt></a> depends on a <a class="reference internal" href="#cobol.loader.Lexer" title="cobol.loader.Lexer"><tt class="xref py py-class docutils literal"><span class="pre">cobol.loader.Lexer</span></tt></a>
instance to do lexical scanning of
COBOL source. The lexical scanner can be subclassed to pre-process COBOL
source.  This is necessary because of the variety of source formats that
are permitted.  Shop standards may include or exclude features like
program identification, line numbers, format control and other
decoration of the input.</p>
<p>The <a class="reference internal" href="#cobol.loader.RecordFactory.makeRecord" title="cobol.loader.RecordFactory.makeRecord"><tt class="xref py py-meth docutils literal"><span class="pre">cobol.loader.RecordFactory.makeRecord()</span></tt></a> method
does the parsing of
the record definition. Each individual DDE statement is parsed.  The
level number information is used to define the correct grouping of
elements.  When the structure(s) is parsed, it is decorated with size and
offset information for each element.</p>
<p>Note that multiple 01 levels are possible in a single COBOL copybook.
This is confusing and potentially complicated, but it occurs IRL.</p>
</div>
<div class="section" id="field-values">
<h3>10.2.2.4.4. Field Values<a class="headerlink" href="#field-values" title="Permalink to this headline">¶</a></h3>
<p>The COBOL language, and IBM&#8217;s extensions,
provide for a number of usage options.  In this application, three basic types
of usage strategies are supported:</p>
<ul class="simple">
<li><strong>DISPLAY</strong>.  These are bytes, one per character, described by the picture clause.
They can be EBCDIC or ASCII.  We use the <tt class="docutils literal"><span class="pre">codecs</span></tt> module to
convert EBCDIC characters to Unicode for further processing.</li>
<li><strong>COMP</strong>.  These are binary fields of 2, 4 or 8 bytes, with the size implied by the picture clause.</li>
<li><strong>COMP-3</strong>.  These are packed decimal fields, with the size derived from the picture clause;
there are two digits packed into each byte, with an extra half-byte for a sign.</li>
</ul>
<p>These require different strategies for decoding the input bytes.</p>
<p>Additional types include COMP-1 and COMP-2 which are single- and double-precision floating-point.
They&#8217;re rare enough that we ignore them.</p>
</div>
<div class="section" id="additional-requirements">
<h3>10.2.2.4.5. Additional Requirements<a class="headerlink" href="#additional-requirements" title="Permalink to this headline">¶</a></h3>
<p>Support for Occurs Depending On is based several features of COBOL.</p>
<p>The syntax for ODO is more complex: <tt class="docutils literal"><span class="pre">OCCURS</span> <span class="pre">[int</span> <span class="pre">TO]</span> <span class="pre">int</span> <span class="pre">[TIMES]</span> <span class="pre">DEPENDING</span> <span class="pre">[ON]</span> <span class="pre">name</span></tt>.
Compare this with simple <tt class="docutils literal"><span class="pre">OCCURS</span> <span class="pre">int</span> <span class="pre">[TIMES]</span></tt>.</p>
<p>This leads to variable byte positions for data items which follow the occurs clause,
based on the <em>name</em> value.</p>
<p>This means that the offset is not necessarily fixed when there&#8217;s a complex ODO.
We&#8217;ll have to make offset (and size) a property that has one of two strategies.</p>
<ul class="simple">
<li>Statically Located. The base case where offsets are static.</li>
<li>Variably Located. The complex ODO situation where there&#8217;s an ODO in the record.
<strong>All</strong> ODO &#8220;depends on&#8221; fields become part of the offset calculation. This means
we need an index for depends on clauses.</li>
</ul>
<p>The technical buzzphrase is &#8220;a data item following, but not subordinate to, a variable-length table in the same level-01 record.&#8221;</p>
<p>See <a class="reference external" href="http://publib.boulder.ibm.com/infocenter/comphelp/v7v91/index.jsp?topic=%2Fcom.ibm.aix.cbl.doc%2Ftptbl27.htm">http://publib.boulder.ibm.com/infocenter/comphelp/v7v91/index.jsp?topic=%2Fcom.ibm.aix.cbl.doc%2Ftptbl27.htm</a></p>
<p>These are the &#8220;Appendix D, Complex ODO&#8221; rules.</p>
<p>The design consequences are these.</p>
<ol class="arabic">
<li><p class="first">There are three species of relationships between DDE elements:
Predecessor/Successor, Parent/Child (or Group/Elementary),
and Redefines. Currently, the pred/succ relationship is
implied by the parent having a sequence of children. We can&#8217;t easily
find a predecessor without a horrible <img class="math" src="_images/math/4a8f7c6a584085fded7ccfd6db527ff6acba8981.png" alt="\textbf{O}(n)"/> search.</p>
</li>
<li><p class="first">There are two strategies for doing offset/size calculations.</p>
<ul>
<li><p class="first">Statically Located. The <a class="reference internal" href="cobol_defs.html#cobol.defs.setSizeAndOffset" title="cobol.defs.setSizeAndOffset"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.setSizeAndOffset()</span></tt></a> function can be used
once, right after the schema is parsed.</p>
</li>
<li><p class="first">Variably Located. The calculation of size and offset is based on live data.
The <a class="reference internal" href="cobol_defs.html#cobol.defs.setSizeAndOffset" title="cobol.defs.setSizeAndOffset"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.setSizeAndOffset()</span></tt></a> function must be used after the
row is fetched but before any other processing.</p>
<p>This is done automagically by a <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> object.</p>
</li>
</ul>
</li>
</ol>
<p>The offset calculation can be seen as a recursive trip &#8220;up&#8221; the tree
following redefines, predecessor and parent relationships (in that order)
to calculate the size of everything prior to the element in question.
We could make offset and total size into properties which do this recursive
calculation.</p>
<p>The &#8220;size&#8221; of a elementary items is still simply based on the picture.
For group items, however, size becomes based on total size which in
turn, may be based on ODO data.</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">88-level items could create boolean-valued properties.</p>
</div>
</div>
<div class="section" id="model">
<h3>10.2.2.4.6. Model<a class="headerlink" href="#model" title="Permalink to this headline">¶</a></h3>
<div class="highlight-none"><div class="highlight"><pre>http://yuml.me/diagram/scruffy;/class/
#cobol_loader,
[Schema]&lt;&gt;-[RepeatingAttribute],
[SchemaLoader]-builds-&gt;[Schema],
[SchemaLoader]^[COBOLSchemaLoader],
[COBOLSchemaLoader]-&gt;[Lexer],
[COBOLSchemaLoader]-&gt;[RecordFactory],
[RecordFactory]&lt;&gt;-[DDE].
</pre></div>
</div>
<img alt="_images/cobol_loader.png" src="_images/cobol_loader.png" />
</div>
</div>
<div class="section" id="overheads">
<h2>10.2.2.5. Overheads<a class="headerlink" href="#overheads" title="Permalink to this headline">¶</a></h2>
<p>Ultimately, we&#8217;re writing a new <a class="reference internal" href="schema_loader.html#schema.loader.ExternalSchemaLoader" title="schema.loader.ExternalSchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader</span></tt></a>.
The purpose of this is to build a <a class="reference internal" href="schema.html#schema.Schema" title="schema.Schema"><tt class="xref py py-class docutils literal"><span class="pre">schema.Schema</span></tt></a> instance
from COBOL source instead of some other source.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;stingray.cobol.loader -- Parse a COBOL DDE and build a usable Schema.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">Iterator</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">stingray.schema.loader</span>
<span class="kn">import</span> <span class="nn">stingray.cobol</span>
<span class="kn">import</span> <span class="nn">stingray.cobol.defs</span>
</pre></div>
</div>
<p>A module-level logger.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">logger</span><span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span> <span class="n">__name__</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="parsing-exceptions">
<h2>10.2.2.6. Parsing Exceptions<a class="headerlink" href="#parsing-exceptions" title="Permalink to this headline">¶</a></h2>
<dl class="class">
<dt id="cobol.loader.SyntaxError">
<em class="property">class </em><tt class="descclassname">cobol.loader.</tt><tt class="descname">SyntaxError</tt><a class="headerlink" href="#cobol.loader.SyntaxError" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>These are compilation problems.  We have syntax which
is utterly baffling.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SyntaxError</span><span class="p">(</span> <span class="ne">Exception</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;COBOL syntax error.&quot;&quot;&quot;</span>
    <span class="k">pass</span>
</pre></div>
</div>
</div>
<div class="section" id="picture-clause-parsing">
<h2>10.2.2.7. Picture Clause Parsing<a class="headerlink" href="#picture-clause-parsing" title="Permalink to this headline">¶</a></h2>
<p>Picture clause parsing is done as the DDE element is created.  Not for a great
reason.  It&#8217;s derived data from the source picture clause.</p>
<p>It could be done in the parser, also.</p>
<dl class="class">
<dt id="cobol.loader.Picture">
<em class="property">class </em><tt class="descclassname">cobol.loader.</tt><tt class="descname">Picture</tt><a class="headerlink" href="#cobol.loader.Picture" title="Permalink to this definition">¶</a></dt>
<dd><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Final:</th><td class="field-body">the final picture</td>
</tr>
<tr class="field-even field"><th class="field-name">Alpha:</th><td class="field-body">boolean; True if any <tt class="docutils literal"><span class="pre">&quot;X&quot;</span></tt> or <tt class="docutils literal"><span class="pre">&quot;A&quot;</span></tt>; False if all <tt class="docutils literal"><span class="pre">&quot;9&quot;</span></tt> and related</td>
</tr>
<tr class="field-odd field"><th class="field-name">Length:</th><td class="field-body">length of the final picture</td>
</tr>
<tr class="field-even field"><th class="field-name">Scale:</th><td class="field-body">count of <tt class="docutils literal"><span class="pre">&quot;P&quot;</span></tt> positions, often zero</td>
</tr>
<tr class="field-odd field"><th class="field-name">Precision:</th><td class="field-body">digits to the right of the decimal point</td>
</tr>
<tr class="field-even field"><th class="field-name">Signed:</th><td class="field-body">boolean; True if any <tt class="docutils literal"><span class="pre">&quot;S&quot;</span></tt>, <tt class="docutils literal"><span class="pre">&quot;-&quot;</span></tt> or related</td>
</tr>
<tr class="field-odd field"><th class="field-name">Decimal:</th><td class="field-body"><tt class="docutils literal"><span class="pre">&quot;.&quot;</span></tt> or <tt class="docutils literal"><span class="pre">&quot;V&quot;</span></tt> or <tt class="docutils literal"><span class="pre">None</span></tt></td>
</tr>
</tbody>
</table>
</dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="n">Picture</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span> <span class="s">&#39;Picture&#39;</span><span class="p">,</span>
    <span class="s">&#39;final, alpha, length, scale, precision, signed, decimal&#39;</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="function">
<dt id="cobol.loader.picture_parser">
<tt class="descclassname">cobol.loader.</tt><tt class="descname">picture_parser</tt><big>(</big><em>pic</em><big>)</big><a class="headerlink" href="#cobol.loader.picture_parser" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">picture_parser</span><span class="p">(</span> <span class="n">pic</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rewrite a picture clause to eliminate ()&#39;s, S&#39;s, V&#39;s, P&#39;s, etc.</span>
<span class="sd">    :param pic: Sounce text.</span>
<span class="sd">    :returns: Picture instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span><span class="o">=</span> <span class="p">[]</span>
    <span class="n">scale</span><span class="p">,</span> <span class="n">precision</span><span class="p">,</span> <span class="n">signed</span><span class="p">,</span> <span class="n">decimal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">None</span>
    <span class="n">char_iter</span><span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">char_iter</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;A&#39;</span><span class="p">,</span><span class="s">&#39;B&#39;</span><span class="p">,</span><span class="s">&#39;X&#39;</span><span class="p">,</span><span class="s">&#39;Z&#39;</span><span class="p">,</span><span class="s">&#39;9&#39;</span><span class="p">,</span><span class="s">&#39;0&#39;</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="s">&#39;,&#39;</span><span class="p">,</span><span class="s">&#39;+&#39;</span><span class="p">,</span><span class="s">&#39;-&#39;</span><span class="p">,</span><span class="s">&#39;*&#39;</span><span class="p">,</span><span class="s">&#39;$&#39;</span><span class="p">):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">c</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">decimal</span><span class="p">:</span> <span class="n">precision</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;D&#39;</span><span class="p">:</span>
            <span class="n">nc</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">char_iter</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nc</span> <span class="o">==</span> <span class="s">&quot;B&quot;</span><span class="p">,</span> <span class="s">&quot;picture error in {0!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;DB&quot;</span> <span class="p">)</span>
            <span class="n">signed</span><span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span>  <span class="s">&#39;C&#39;</span><span class="p">:</span>
            <span class="n">nc</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">char_iter</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">nc</span> <span class="o">==</span> <span class="s">&quot;R&quot;</span><span class="p">,</span> <span class="s">&quot;picture error in {0!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;CR&quot;</span> <span class="p">)</span>
            <span class="n">signed</span><span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;(&#39;</span><span class="p">:</span>
            <span class="n">irpt</span><span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">char_iter</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">:</span> <span class="k">break</span>
                    <span class="n">irpt</span> <span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">irpt</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span> <span class="n">c</span> <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span> <span class="s">&quot;picture error in {0!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span> <span class="p">)</span>
            <span class="k">assert</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;)&#39;</span><span class="p">,</span>  <span class="s">&quot;picture error in {0!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="n">irpt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span>
        <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;S&#39;</span><span class="p">:</span>
            <span class="c"># silently drop an &quot;S&quot;.</span>
            <span class="c"># Note that &#39;S&#39; plus a SIGN SEPARATE option increases the size of the picture!</span>
            <span class="n">signed</span><span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">c</span>  <span class="o">==</span> <span class="s">&#39;P&#39;</span><span class="p">:</span>
            <span class="c"># &quot;P&quot; sets scale and isn&#39;t represented.</span>
            <span class="n">scale</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">c</span>  <span class="o">==</span> <span class="s">&quot;V&quot;</span><span class="p">:</span>
            <span class="c"># &quot;V&quot; sets precision and isn&#39;t represented.</span>
            <span class="n">decimal</span><span class="o">=</span> <span class="s">&quot;V&quot;</span>
        <span class="k">elif</span> <span class="n">c</span>  <span class="o">==</span> <span class="s">&quot;.&quot;</span><span class="p">:</span>
            <span class="n">decimal</span><span class="o">=</span> <span class="s">&quot;.&quot;</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="s">&quot;.&quot;</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span> <span class="s">&quot;Picture error in {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pic</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">final</span><span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">out</span> <span class="p">)</span>
    <span class="n">alpha</span><span class="o">=</span> <span class="p">(</span><span class="s">&#39;A&#39;</span> <span class="ow">in</span> <span class="n">final</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;X&#39;</span> <span class="ow">in</span> <span class="n">final</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">final</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="s">&quot;PIC {0} {1} {2} {3} {4}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pic</span><span class="p">,</span> <span class="n">final</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">precision</span><span class="p">)</span> <span class="p">)</span>
    <span class="c"># Note: Actual bytes consumed depends on len(final) and usage!</span>
    <span class="k">return</span> <span class="n">Picture</span><span class="p">(</span> <span class="n">final</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">final</span><span class="p">),</span> <span class="n">scale</span><span class="p">,</span>
        <span class="n">precision</span><span class="p">,</span> <span class="n">signed</span><span class="p">,</span> <span class="n">decimal</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="lexical-scanning">
<h2>10.2.2.8. Lexical Scanning<a class="headerlink" href="#lexical-scanning" title="Permalink to this headline">¶</a></h2>
<p>The lexical scanner can be subclassed to extend its capability.  The default
lexical scanner provides a <a class="reference internal" href="#cobol.loader.Lexer.clean" title="cobol.loader.Lexer.clean"><tt class="xref py py-meth docutils literal"><span class="pre">Lexer.clean()</span></tt></a> method that simply removes comments.
This may need to be overridden to remove line numbers (from positions 72-80),
module identification (from positions 1-5), and format control directives.</p>
<dl class="class">
<dt id="cobol.loader.Lexer">
<em class="property">class </em><tt class="descclassname">cobol.loader.</tt><tt class="descname">Lexer</tt><a class="headerlink" href="#cobol.loader.Lexer" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Basic lexer that simply removes comments and the first six positions of each line.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Lexer</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Lexical scanner for COBOL.  Iterates over tokens in source text.&quot;&quot;&quot;</span>
    <span class="n">separator</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="s">r&#39;[.,;]?\s&#39;</span> <span class="p">)</span>
    <span class="n">quote1</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="s">r&quot;&#39;[^&#39;]*&#39;&quot;</span> <span class="p">)</span>
    <span class="n">quote2</span><span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span> <span class="s">r&#39;&quot;[^&quot;]*&quot;&#39;</span> <span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">replacing</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__qualname__</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replacing</span><span class="o">=</span> <span class="n">replacing</span> <span class="ow">or</span> <span class="p">[]</span>
</pre></div>
</div>
<dl class="method">
<dt id="cobol.loader.Lexer.clean">
<tt class="descclassname">Lexer.</tt><tt class="descname">clean</tt><big>(</big><em>line</em><big>)</big><a class="headerlink" href="#cobol.loader.Lexer.clean" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">clean</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">line</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default cleaner removes positions 0:6.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
</pre></div>
</div>
<dl class="method">
<dt id="cobol.loader.Lexer.scan">
<tt class="descclassname">Lexer.</tt><tt class="descname">scan</tt><big>(</big><em>text</em><big>)</big><a class="headerlink" href="#cobol.loader.Lexer.scan" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">scan</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">text</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locate the next token in the input stream.</span>
<span class="sd">    - Clean 6-char lead-in plus trailing whitespace</span>
<span class="sd">    - Add one extra space to distinguish end-of-line ``&#39;. &#39;``</span>
<span class="sd">      from picture clause.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
        <span class="n">text</span><span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">all_lines</span><span class="o">=</span> <span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span> <span class="p">)</span>
    <span class="c"># Remove comments and blank lines</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">(</span> <span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_lines</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">,</span> <span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">line</span> <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="k">for</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacing</span><span class="p">:</span>
            <span class="n">line</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">replacing</span><span class="p">:</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">line</span> <span class="p">)</span>
        <span class="n">current</span><span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">current</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;&#39;&quot;</span><span class="p">:</span>
                <span class="c"># apostrophe string, break on balancing apostrophe</span>
                <span class="n">match</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote1</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">current</span> <span class="p">)</span>
                <span class="n">space</span><span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">current</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">:</span>
                <span class="c"># quote string, break on balancing quote</span>
                <span class="n">match</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote2</span><span class="o">.</span><span class="n">match</span><span class="p">(</span> <span class="n">current</span> <span class="p">)</span>
                <span class="n">space</span><span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">match</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separator</span><span class="o">.</span><span class="n">search</span><span class="p">(</span> <span class="n">current</span> <span class="p">)</span>
                <span class="n">space</span><span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">space</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c"># starts with separator</span>
                    <span class="n">space</span><span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">token</span><span class="p">,</span> <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="p">[:</span><span class="n">space</span><span class="p">],</span> <span class="n">current</span><span class="p">[</span><span class="n">space</span><span class="p">:]</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="n">token</span> <span class="p">)</span>
            <span class="k">yield</span> <span class="n">token</span>
</pre></div>
</div>
<dl class="class">
<dt id="cobol.loader.Lexer_Long_Lines">
<em class="property">class </em><tt class="descclassname">cobol.loader.</tt><tt class="descname">Lexer_Long_Lines</tt><a class="headerlink" href="#cobol.loader.Lexer_Long_Lines" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>More sophisticated lexer that removes the first six positions of each line.
If the line is over 72 positions, it also removes positions [71:80].
Since it&#8217;s an extension to <a class="reference internal" href="#cobol.loader.Lexer" title="cobol.loader.Lexer"><tt class="xref py py-class docutils literal"><span class="pre">cobol.loader.Lexer</span></tt></a>, it also removes comments.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Lexer_Long_Lines</span><span class="p">(</span> <span class="n">Lexer</span> <span class="p">):</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">line</span> <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove positions 72:80 and 0:6.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">72</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">72</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
</pre></div>
</div>
<p>We use this by subclassing <tt class="xref py py-class docutils literal"><span class="pre">cobol.COBOLSchemaLoader</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MySchemaLoader</span><span class="p">(</span> <span class="n">cobol</span><span class="o">.</span><span class="n">COBOLSchemaLoader</span> <span class="p">):</span>
    <span class="n">lexer_class</span><span class="o">=</span> <span class="n">cobol</span><span class="o">.</span><span class="n">Lexer_Long_Lines</span>
</pre></div>
</div>
</div>
<div class="section" id="parsing">
<h2>10.2.2.9. Parsing<a class="headerlink" href="#parsing" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference internal" href="#cobol.loader.RecordFactory" title="cobol.loader.RecordFactory"><tt class="xref py py-class docutils literal"><span class="pre">cobol.loader.RecordFactory</span></tt></a> class is the parser for record definitions.
The parser has three basic sets of methods:</p>
<ol class="arabic simple">
<li>clause parsing methods,</li>
<li>element parsing methods and</li>
<li>complete record layout parsing.</li>
</ol>
<p>Parsing a record layout involves parsing a sequence of elements and
assembling them into a proper structure.  Each element consists of a sequence of
individual clauses.</p>
<p>The picture clauses are parsed separately by the DDE during its initialization.</p>
<dl class="class">
<dt id="cobol.loader.RecordFactory">
<em class="property">class </em><tt class="descclassname">cobol.loader.</tt><tt class="descname">RecordFactory</tt><a class="headerlink" href="#cobol.loader.RecordFactory" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RecordFactory</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Parse a copybook, creating a DDE structure.&quot;&quot;&quot;</span>
    <span class="n">noisewords</span><span class="o">=</span> <span class="p">{</span><span class="s">&quot;WHEN&quot;</span><span class="p">,</span><span class="s">&quot;IS&quot;</span><span class="p">,</span><span class="s">&quot;TIMES&quot;</span><span class="p">}</span>
    <span class="n">keywords</span><span class="o">=</span> <span class="p">{</span><span class="s">&quot;BLANK&quot;</span><span class="p">,</span><span class="s">&quot;ZERO&quot;</span><span class="p">,</span><span class="s">&quot;ZEROS&quot;</span><span class="p">,</span><span class="s">&quot;ZEROES&quot;</span><span class="p">,</span><span class="s">&quot;SPACES&quot;</span><span class="p">,</span>
        <span class="s">&quot;DATE&quot;</span><span class="p">,</span><span class="s">&quot;FORMAT&quot;</span><span class="p">,</span><span class="s">&quot;EXTERNAL&quot;</span><span class="p">,</span><span class="s">&quot;GLOBAL&quot;</span><span class="p">,</span>
        <span class="s">&quot;JUST&quot;</span><span class="p">,</span><span class="s">&quot;JUSTIFIED&quot;</span><span class="p">,</span><span class="s">&quot;LEFT&quot;</span><span class="p">,</span><span class="s">&quot;RIGHT&quot;</span>
        <span class="s">&quot;OCCURS&quot;</span><span class="p">,</span><span class="s">&quot;DEPENDING&quot;</span><span class="p">,</span><span class="s">&quot;ON&quot;</span><span class="p">,</span><span class="s">&quot;TIMES&quot;</span><span class="p">,</span>
        <span class="s">&quot;PIC&quot;</span><span class="p">,</span><span class="s">&quot;PICTURE&quot;</span><span class="p">,</span>
        <span class="s">&quot;REDEFINES&quot;</span><span class="p">,</span><span class="s">&quot;RENAMES&quot;</span><span class="p">,</span>
        <span class="s">&quot;SIGN&quot;</span><span class="p">,</span><span class="s">&quot;LEADING&quot;</span><span class="p">,</span><span class="s">&quot;TRAILING&quot;</span><span class="p">,</span><span class="s">&quot;SEPARATE&quot;</span><span class="p">,</span><span class="s">&quot;CHARACTER&quot;</span><span class="p">,</span>
        <span class="s">&quot;SYNCH&quot;</span><span class="p">,</span><span class="s">&quot;SYNCHRONIZED&quot;</span><span class="p">,</span>
        <span class="s">&quot;USAGE&quot;</span><span class="p">,</span><span class="s">&quot;DISPLAY&quot;</span><span class="p">,</span><span class="s">&quot;COMP-3&quot;</span><span class="p">,</span>
        <span class="s">&quot;VALUE&quot;</span><span class="p">,</span><span class="s">&quot;.&quot;</span><span class="p">}</span>

    <span class="n">redefines_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">Redefines</span>
    <span class="n">successor_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">Successor</span>
    <span class="n">group_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">Group</span>
    <span class="n">display_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">UsageDisplay</span>
    <span class="n">comp_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">UsageComp</span>
    <span class="n">comp3_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">UsageComp3</span>
    <span class="n">occurs_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">Occurs</span>
    <span class="n">occurs_fixed_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">OccursFixed</span>
    <span class="n">occurs_dependingon_class</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">OccursDependingOn</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__qualname__</span> <span class="p">)</span>
</pre></div>
</div>
<p>Each of these parsing functions has a precondition of the last examined token
in <tt class="docutils literal"><span class="pre">self.token</span></tt>.  They have a post-condition of leaving a <strong>not</strong>-examined
token in <tt class="docutils literal"><span class="pre">self.token</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">picture</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a PICTURE clause.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;IS&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="n">pic</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pic</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">blankWhenZero</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gracefully skip over a BLANK WHEN ZERO clause.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;WHEN&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;ZERO&quot;</span><span class="p">,</span><span class="s">&quot;ZEROES&quot;</span><span class="p">,</span><span class="s">&quot;ZEROS&quot;</span><span class="p">}:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">justified</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gracefully skip over a JUSTIFIED clause.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;RIGHT&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">occurs</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse an OCCURS clause.&quot;&quot;&quot;</span>
    <span class="n">occurs</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">occurs</span> <span class="o">==</span> <span class="s">&quot;TO&quot;</span><span class="p">:</span>
        <span class="c"># format 2: occurs depending on with assumed 1 for the lower limit</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs2</span><span class="p">(</span> <span class="s">&#39;&#39;</span> <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;TO&quot;</span><span class="p">:</span>
        <span class="c"># format 2: occurs depending on</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs2</span><span class="p">(</span> <span class="n">occurs</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># format 1: fixed-length</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;TIMES&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">occurs_cruft</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs_fixed_class</span><span class="p">(</span><span class="n">occurs</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">occurs_cruft</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Soak up additional key and index sub-clauses.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;ASCENDING&quot;</span><span class="p">,</span><span class="s">&quot;DESCENDING&quot;</span><span class="p">}:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;KEY&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;IS&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="c"># get key data names</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;INDEXED&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;BY&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="c"># get indexed data names</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">occurs2</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lower</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse the [Occurs n TO] m Times Depending On name&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="n">upper</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="c"># May be significant as a default size.</span>
    <span class="n">default_size</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;TIMES&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;DEPENDING&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;ON&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="n">name</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">occurs_cruft</span><span class="p">()</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs_dependingon_class</span><span class="p">(</span> <span class="n">name</span><span class="p">,</span> <span class="n">default_size</span> <span class="p">)</span>
    <span class="c">#raise stingray.cobol.defs.UnsupportedError( &quot;Occurs depending on&quot; )</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">redefines</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a REDEFINES clause.&quot;&quot;&quot;</span>
    <span class="n">redef</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">redefines_class</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">redef</span><span class="p">)</span>
</pre></div>
</div>
<p>A <tt class="docutils literal"><span class="pre">RENAMES</span></tt> creates an alternative group-level name for some elementary items.
It&#8217;s considered bad practice.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">renames</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise an exception on a RENAMES clause.&quot;&quot;&quot;</span>
    <span class="n">ren1</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;THRU&quot;</span><span class="p">,</span><span class="s">&quot;THROUGH&quot;</span><span class="p">}:</span>
        <span class="n">ren2</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lext</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">UnsupportedError</span><span class="p">(</span> <span class="s">&quot;Renames clause&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>There are two variations on the <tt class="docutils literal"><span class="pre">SIGN</span></tt> clause syntax.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">sign1</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise an exception on a SIGN clause.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;IS&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;LEADING&quot;</span><span class="p">,</span><span class="s">&quot;TRAILING&quot;</span><span class="p">}:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sign2</span><span class="p">()</span>
    <span class="c"># TODO: this may change the size to add a sign byte</span>
    <span class="k">raise</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">UnsupportedError</span><span class="p">(</span> <span class="s">&quot;Sign clause&quot;</span> <span class="p">)</span>
<span class="k">def</span> <span class="nf">sign2</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise an exception on a SIGN clause.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;SEPARATE&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;CHARACTER&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">UnsupportedError</span><span class="p">(</span> <span class="s">&quot;Sign clause&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">synchronized</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise an exception on a SYNCHRONIZED clause.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;LEFT&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;RIGHT&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">UnsupportedError</span><span class="p">(</span> <span class="s">&quot;Synchronized clause&quot;</span> <span class="p">)</span>
</pre></div>
</div>
<p>There are two variations on the <tt class="docutils literal"><span class="pre">USAGE</span></tt> clause syntax.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">usage</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a USAGE clause.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;IS&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="n">use</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage2</span><span class="p">(</span> <span class="n">use</span> <span class="p">)</span>
<span class="k">def</span> <span class="nf">usage2</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">use</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a correct Usage instance based on the USAGE clause.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use</span> <span class="o">==</span> <span class="s">&quot;DISPLAY&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_class</span><span class="p">(</span><span class="n">use</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use</span> <span class="o">==</span> <span class="s">&quot;COMPUTATIONAL&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_class</span><span class="p">(</span><span class="n">use</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use</span> <span class="o">==</span> <span class="s">&quot;COMP&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp_class</span><span class="p">(</span><span class="n">use</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use</span> <span class="o">==</span> <span class="s">&quot;COMPUTATIONAL-3&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp3_class</span><span class="p">(</span><span class="n">use</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">use</span> <span class="o">==</span> <span class="s">&quot;COMP-3&quot;</span><span class="p">:</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">comp3_class</span><span class="p">(</span><span class="n">use</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span> <span class="s">&quot;Unknown usage clause {!r}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">use</span><span class="p">)</span> <span class="p">)</span>
</pre></div>
</div>
<p>For 88-level items, the value clause can be quite long.
Otherwise, it&#8217;s just a single item. We have to absorb all quoted literal values.
It may be that we have to absorb all non-keyword values.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">value</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a VALUE clause.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;IS&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="n">lit</span><span class="o">=</span> <span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">),]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
        <span class="n">lit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lit</span>
</pre></div>
</div>
<p>This fits the generator design pattern well.  The low-level <a class="reference internal" href="#cobol.loader.RecordFactory.dde_iter" title="cobol.loader.RecordFactory.dde_iter"><tt class="xref py py-meth docutils literal"><span class="pre">RecordFactory.dde_iter()</span></tt></a> method
emits individual DDE statements.  These will be assembled into an overall record
definition, below.</p>
<dl class="method">
<dt id="cobol.loader.RecordFactory.dde_iter">
<tt class="descclassname">RecordFactory.</tt><tt class="descname">dde_iter</tt><big>(</big><em>lexer</em><big>)</big><a class="headerlink" href="#cobol.loader.RecordFactory.dde_iter" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">dde_iter</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lexer</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a single DDE from an entry of clauses.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="o">=</span> <span class="n">lexer</span>

    <span class="k">for</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">:</span>
        <span class="c"># Start with the level.</span>
        <span class="n">level</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>

        <span class="c"># Pick off a name, if present</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">keywords</span><span class="p">:</span>
            <span class="n">name</span><span class="o">=</span> <span class="s">&quot;FILLER&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>

        <span class="c"># Defaults</span>
        <span class="n">usage</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_class</span><span class="p">(</span> <span class="s">&quot;&quot;</span> <span class="p">)</span>
        <span class="n">pic</span><span class="o">=</span> <span class="bp">None</span>
        <span class="n">occurs</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs_class</span><span class="p">()</span>
        <span class="n">redefines</span><span class="o">=</span> <span class="bp">None</span> <span class="c"># set to Redefines below or by addChild() to Group or Successor</span>

        <span class="c"># Accumulate the relevant clauses, dropping noise words and irrelevant clauses.</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">!=</span> <span class="s">&#39;.&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;BLANK&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blankWhenZero</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;EXTERNAL&quot;</span><span class="p">,</span><span class="s">&quot;GLOBAL&quot;</span><span class="p">}:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;JUST&quot;</span><span class="p">,</span><span class="s">&quot;JUSTIFIED&quot;</span><span class="p">}:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">justified</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;OCCURS&quot;</span><span class="p">:</span>
                <span class="n">occurs</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">occurs</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;PIC&quot;</span><span class="p">,</span><span class="s">&quot;PICTURE&quot;</span><span class="p">}:</span>
                <span class="n">pic</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">picture</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;REDEFINES&quot;</span><span class="p">:</span>
                <span class="c"># Must be first and no other clauses allowed.</span>
                <span class="c"># Special case: simpler if 01 level ignores this clause.</span>
                <span class="n">clause</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">redefines</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s">&#39;01&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s">&quot;Ignoring top-level REDEFINES&quot;</span> <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">redefines</span><span class="o">=</span> <span class="n">clause</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;RENAMES&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">renames</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;SIGN&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sign1</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="ow">in</span> <span class="p">{</span><span class="s">&quot;LEADING&quot;</span><span class="p">,</span><span class="s">&quot;TRAILING&quot;</span><span class="p">}:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sign2</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;SYNCHRONIZED&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">synchronized</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;USAGE&quot;</span><span class="p">:</span>
                <span class="n">usage</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;VALUE&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># Keyword USAGE is optional</span>
                    <span class="n">usage</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">usage2</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lex</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span> <span class="s">&quot;{!r} unrecognized&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span>

        <span class="c"># Create and yield the DDE</span>
        <span class="k">if</span> <span class="n">pic</span><span class="p">:</span>
            <span class="c"># Parse the picture; update the USAGE clause with details.</span>
            <span class="n">sizeScalePrecision</span><span class="o">=</span> <span class="n">picture_parser</span><span class="p">(</span> <span class="n">pic</span> <span class="p">)</span>
            <span class="n">usage</span><span class="o">.</span><span class="n">setTypeInfo</span><span class="p">(</span><span class="n">sizeScalePrecision</span><span class="p">)</span>

            <span class="c"># Build an elementary DDE</span>
            <span class="n">dde</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">DDE</span><span class="p">(</span>
                <span class="n">level</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span> <span class="n">occurs</span><span class="o">=</span><span class="n">occurs</span><span class="p">,</span> <span class="n">redefines</span><span class="o">=</span><span class="n">redefines</span><span class="p">,</span>
                <span class="n">pic</span><span class="o">=</span><span class="n">pic</span><span class="p">,</span> <span class="n">sizeScalePrecision</span><span class="o">=</span><span class="n">sizeScalePrecision</span> <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Build a group-level DDE</span>
            <span class="n">dde</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">DDE</span><span class="p">(</span>
                <span class="n">level</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">usage</span><span class="o">=</span><span class="n">usage</span><span class="p">,</span> <span class="n">occurs</span><span class="o">=</span><span class="n">occurs</span><span class="p">,</span> <span class="n">redefines</span><span class="o">=</span><span class="n">redefines</span> <span class="p">)</span>

        <span class="k">yield</span> <span class="n">dde</span>
</pre></div>
</div>
<p>Note that some clauses (like <tt class="docutils literal"><span class="pre">REDEFINES</span></tt>) occupy a special place in COBOL syntax.
We&#8217;re not fastidious about enforcing COBOL semantic rules. Presumably the
source is proper COBOL and was actually used to create the source file.</p>
<p>The overall parsing method, <a class="reference internal" href="#cobol.loader.RecordFactory.makeRecord" title="cobol.loader.RecordFactory.makeRecord"><tt class="xref py py-meth docutils literal"><span class="pre">RecordFactory.makeRecord()</span></tt></a> is an iterator
that yields the top-level parsed items.
It uses the <a class="reference internal" href="#cobol.loader.RecordFactory.dde_iter" title="cobol.loader.RecordFactory.dde_iter"><tt class="xref py py-meth docutils literal"><span class="pre">RecordFactory.dde_iter()</span></tt></a> to get tokens and accumulates a proper
hierarchy of individual DDE instances.</p>
<p>This will yield the <tt class="docutils literal"><span class="pre">01</span></tt>-level records. Generally, there&#8217;s only one.</p>
<dl class="method">
<dt id="cobol.loader.RecordFactory.makeRecord">
<tt class="descclassname">RecordFactory.</tt><tt class="descname">makeRecord</tt><big>(</big><em>lexer</em><big>)</big><a class="headerlink" href="#cobol.loader.RecordFactory.makeRecord" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">makeRecord</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">lexer</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse an entire copybook block of text.&quot;&quot;&quot;</span>
    <span class="c"># Parse the first DDE and establish the context stack.</span>
    <span class="n">ddeIter</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dde_iter</span><span class="p">(</span> <span class="n">lexer</span> <span class="p">)</span>
    <span class="n">top</span><span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">ddeIter</span><span class="p">)</span>
    <span class="n">top</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">top</span><span class="p">),</span> <span class="bp">None</span>
    <span class="n">top</span><span class="o">.</span><span class="n">allocation</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">Group</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">=</span> <span class="p">[</span><span class="n">top</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">dde</span> <span class="ow">in</span> <span class="n">ddeIter</span><span class="p">:</span>
        <span class="c">#print( dde, &quot;:&quot;, self.context[-1] )</span>
        <span class="c"># If a lower level or same level, pop context</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="ow">and</span> <span class="n">dde</span><span class="o">.</span><span class="n">level</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">level</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># Special case of multiple 01 levels.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span> <span class="s">&quot;Multiple {0} levels&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">level</span><span class="p">)</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decorate</span><span class="p">(</span> <span class="n">top</span> <span class="p">)</span>
            <span class="k">yield</span> <span class="n">top</span>
            <span class="c"># Create a new top with this DDE.</span>
            <span class="n">top</span><span class="o">=</span> <span class="n">dde</span>
            <span class="n">top</span><span class="o">.</span><span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">top</span><span class="p">),</span> <span class="bp">None</span>
            <span class="n">top</span><span class="o">.</span><span class="n">allocation</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">Group</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">=</span> <span class="p">[</span><span class="n">top</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># General case.</span>
            <span class="c"># Make this DDE part of the parent DDE at the top of the context stack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addChild</span><span class="p">(</span> <span class="n">dde</span> <span class="p">)</span>
            <span class="c"># Push this DDE onto the context stack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">dde</span> <span class="p">)</span>
            <span class="c"># Handle special case of &quot;88&quot; level children.</span>
            <span class="k">if</span> <span class="n">dde</span><span class="o">.</span><span class="n">level</span> <span class="o">==</span> <span class="s">&#39;88&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">dde</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">picture</span><span class="p">,</span> <span class="s">&quot;88 not under elementary item&quot;</span>
                <span class="n">dde</span><span class="o">.</span><span class="n">size</span><span class="o">=</span> <span class="n">dde</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">size</span>
                <span class="n">dde</span><span class="o">.</span><span class="n">usage</span><span class="o">=</span> <span class="n">dde</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">usage</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">decorate</span><span class="p">(</span> <span class="n">top</span> <span class="p">)</span>
    <span class="k">yield</span> <span class="n">top</span>
</pre></div>
</div>
<dl class="method">
<dt id="cobol.loader.RecordFactory.decorate">
<tt class="descclassname">RecordFactory.</tt><tt class="descname">decorate</tt><big>(</big><em>top</em><big>)</big><a class="headerlink" href="#cobol.loader.RecordFactory.decorate" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>The final stages of compilation:</p>
<ul>
<li><p class="first">Resolve <tt class="docutils literal"><span class="pre">REDEFINES</span></tt> names using <a class="reference internal" href="cobol_defs.html#cobol.defs.resolver" title="cobol.defs.resolver"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.resolver()</span></tt></a>.</p>
</li>
<li><p class="first">Push dimensionality down to each elementary item using <a class="reference internal" href="cobol_defs.html#cobol.defs.setDimensionality" title="cobol.defs.setDimensionality"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.setDimensionality()</span></tt></a>.</p>
</li>
<li><p class="first">Work out size and offset, if possible. Use using <a class="reference internal" href="cobol_defs.html#cobol.defs.setSizeAndOffset" title="cobol.defs.setSizeAndOffset"><tt class="xref py py-func docutils literal"><span class="pre">cobol.defs.setSizeAndOffset()</span></tt></a>
This depends on the presence
of Occurs Depending On. If we can&#8217;t compute size and offset, it must be
computed as each row is read.
This is done automagically by a <a class="reference internal" href="sheet.html#sheet.LazyRow" title="sheet.LazyRow"><tt class="xref py py-class docutils literal"><span class="pre">sheet.LazyRow</span></tt></a> object.</p>
<p>Should we emit a warning? It&#8217;s not usually a mystery that the DDE involves
Occurs Depending On.</p>
</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">top</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Three post-processing steps: resolver, size and offset, dimensionality.&quot;&quot;&quot;</span>
    <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">resolver</span><span class="p">(</span> <span class="n">top</span> <span class="p">)</span>
    <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">setDimensionality</span><span class="p">(</span> <span class="n">top</span> <span class="p">)</span>
    <span class="k">if</span> <span class="n">top</span><span class="o">.</span><span class="n">variably_located</span><span class="p">:</span>
        <span class="c"># Cannot establish all offsets and total sizes.</span>
        <span class="k">pass</span> <span class="c"># Log a warning?</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">defs</span><span class="o">.</span><span class="n">setSizeAndOffset</span><span class="p">(</span> <span class="n">top</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="cobol-schema-loader">
<h2>10.2.2.10. COBOL Schema Loader<a class="headerlink" href="#cobol-schema-loader" title="Permalink to this headline">¶</a></h2>
<p>Given a DDE, create a proper <a class="reference internal" href="schema.html#schema.Schema" title="schema.Schema"><tt class="xref py py-class docutils literal"><span class="pre">schema.Schema</span></tt></a> object which contains
proper <a class="reference internal" href="schema.html#schema.Attribute" title="schema.Attribute"><tt class="xref py py-class docutils literal"><span class="pre">schema.Attribute</span></tt></a> objects for each group and elementary item
in the DDE.</p>
<p>This schema, then, can be used with a COBOL workbook to fetch the rows and
columns.  Note that the conversions involved may be rather complex.</p>
<p>The <a class="reference internal" href="schema.html#schema.Attribute" title="schema.Attribute"><tt class="xref py py-class docutils literal"><span class="pre">schema.Attribute</span></tt></a> objects  are built by a function
that extracts relevant bits of goodness from a DDE.</p>
<div class="highlight-none"><div class="highlight"><pre>http://yuml.me/diagram/scruffy;/class/
#cobol_loader_final,
[COBOLSchemaLoader]-&gt;[Lexer],
[COBOLSchemaLoader]-&gt;[RecordFactory],
[RecordFactory]&lt;&gt;-[DDE],
[DDE]&lt;&gt;-[DDE].
</pre></div>
</div>
<img alt="_images/cobol_final.png" src="_images/cobol_final.png" />
<dl class="function">
<dt id="cobol.loader.make_attr">
<tt class="descclassname">cobol.loader.</tt><tt class="descname">make_attr</tt><big>(</big><big>)</big><a class="headerlink" href="#cobol.loader.make_attr" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_attr</span><span class="p">(</span> <span class="n">aDDE</span> <span class="p">):</span>
    <span class="n">attr</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">cobol</span><span class="o">.</span><span class="n">RepeatingAttribute</span><span class="p">(</span>
        <span class="c"># Essential features:</span>
        <span class="n">name</span><span class="o">=</span> <span class="n">aDDE</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span> <span class="n">aDDE</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
        <span class="n">create</span><span class="o">=</span> <span class="n">aDDE</span><span class="o">.</span><span class="n">usage</span><span class="o">.</span><span class="n">create_func</span><span class="p">,</span>

        <span class="c"># COBOL extensions:</span>
        <span class="n">dde</span><span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">aDDE</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">aDDE</span><span class="o">.</span><span class="n">attribute</span><span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span> <span class="n">attr</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">attr</span>
</pre></div>
</div>
<dl class="function">
<dt id="cobol.loader.make_schema">
<tt class="descclassname">cobol.loader.</tt><tt class="descname">make_schema</tt><big>(</big><big>)</big><a class="headerlink" href="#cobol.loader.make_schema" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>The <a class="reference internal" href="schema.html#schema.Schema" title="schema.Schema"><tt class="xref py py-class docutils literal"><span class="pre">schema.Schema</span></tt></a> &#8211; as a whole &#8211; is built by a function
that converts the DDE&#8217;s into attributes.</p>
<p>This may need to be extended in case other DDE names (i.e. paths)
are required in addition to the elementary names.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_schema</span><span class="p">(</span> <span class="n">dde_iter</span> <span class="p">):</span>
    <span class="n">schema</span><span class="o">=</span> <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Schema</span><span class="p">(</span> <span class="n">dde</span><span class="o">=</span><span class="p">[]</span> <span class="p">)</span>
    <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">dde_iter</span><span class="p">:</span>
        <span class="n">schema</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s">&#39;dde&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">record</span> <span class="p">)</span>
        <span class="k">for</span> <span class="n">aDDE</span> <span class="ow">in</span> <span class="n">record</span><span class="p">:</span>
            <span class="n">attr</span><span class="o">=</span> <span class="n">make_attr</span><span class="p">(</span><span class="n">aDDE</span><span class="p">)</span>
            <span class="n">schema</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">attr</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">schema</span>
</pre></div>
</div>
<dl class="class">
<dt id="cobol.loader.COBOLSchemaLoader">
<em class="property">class </em><tt class="descclassname">cobol.loader.</tt><tt class="descname">COBOLSchemaLoader</tt><a class="headerlink" href="#cobol.loader.COBOLSchemaLoader" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>Here&#8217;s the overall schema loader process: parse and then build a schema.
This is consistent with the <a class="reference internal" href="schema_loader.html#schema.loader.ExternalSchemaLoader" title="schema.loader.ExternalSchemaLoader"><tt class="xref py py-class docutils literal"><span class="pre">schema.loader.ExternalSchemaLoader</span></tt></a>.
However, this is rarely precisely what we want. We&#8217;re almost always going
to break this down into separate steps.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">COBOLSchemaLoader</span><span class="p">(</span> <span class="n">stingray</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">ExternalSchemaLoader</span> <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a COBOL DDE and create a Schema.</span>
<span class="sd">    A subclass may define the lexer_class to customize</span>
<span class="sd">    parsing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lexer_class</span><span class="o">=</span> <span class="n">Lexer</span>
    <span class="n">record_factory_class</span><span class="o">=</span> <span class="n">RecordFactory</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">replacing</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexer_class</span><span class="p">(</span> <span class="n">replacing</span> <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">record_factory_class</span><span class="p">()</span>
</pre></div>
</div>
<dl class="method">
<dt id="cobol.loader.COBOLSchemaLoader.load">
<tt class="descclassname">COBOLSchemaLoader.</tt><tt class="descname">load</tt><big>(</big><big>)</big><a class="headerlink" href="#cobol.loader.COBOLSchemaLoader.load" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">load</span><span class="p">(</span> <span class="bp">self</span> <span class="p">):</span>
    <span class="n">dde_iter</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parser</span><span class="o">.</span><span class="n">makeRecord</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">schema</span><span class="o">=</span> <span class="n">make_schema</span><span class="p">(</span> <span class="n">dde_iter</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">schema</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">replacing</span></tt> keyword argument is a sequence of pairs: <tt class="docutils literal"><span class="pre">[</span> <span class="pre">('old','new'),</span> <span class="pre">...]</span></tt>.
The old text is replaced with the new text.  This seems strange because it is.
COBOL allows replacement text to permit reuse without name clashes.</p>
<p>Note that we provide the &#8220;replacing&#8221; option to the underlying Lexer.
The lexical scanning includes any replacement text.</p>
<p>In some cases, we want to see the intermediate COBOL record definitions.
In this case, we want to do something like the following function.</p>
<dl class="function">
<dt id="cobol.loader.COBOL_schema">
<tt class="descclassname">cobol.loader.</tt><tt class="descname">COBOL_schema</tt><big>(</big><em>source</em>, <em>replacing=None</em><big>)</big><a class="headerlink" href="#cobol.loader.COBOL_schema" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>This function will parse the COBOL copybook, returning a list of the parsed COBOL
01-level records as well as a final schema.</p>
<p>This is based on the (possibly false) assumption
that we&#8217;re making a single schema object from the definitions provided.</p>
<ul class="simple">
<li>In some cases, we want everything merged into a single schema.</li>
<li>In some edge cases, we want each 01-level to provide a distinct
schema object.</li>
</ul>
<p>We may need to revise this function because we need a different lexer.
We might have some awful formatting issue with the source that needs to be
tweaked.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">COBOL_schema</span><span class="p">(</span> <span class="n">source</span><span class="p">,</span> <span class="n">replacing</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
    <span class="n">lexer</span><span class="o">=</span> <span class="n">Lexer</span><span class="p">(</span> <span class="n">replacing</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">=</span> <span class="n">RecordFactory</span><span class="p">()</span>
    <span class="n">dde_list</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">parser</span><span class="o">.</span><span class="n">makeRecord</span><span class="p">(</span> <span class="n">lexer</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">schema</span><span class="o">=</span> <span class="n">make_schema</span><span class="p">(</span> <span class="n">dde_list</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">dde_list</span><span class="p">,</span> <span class="n">schema</span>
</pre></div>
</div>
<dl class="function">
<dt id="cobol.loader.COBOL_schemata">
<tt class="descclassname">cobol.loader.</tt><tt class="descname">COBOL_schemata</tt><big>(</big><em>source</em>, <em>replacing=None</em><big>)</big><a class="headerlink" href="#cobol.loader.COBOL_schemata" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<p>This function will parse the COBOL copybook, returning two lists:</p>
<ul class="simple">
<li>a list of the parsed COBOL 01-level records, and</li>
<li>a list of final schemata, one for each 01-level definition.</li>
</ul>
<p>This is a peculiar extension in the rare case that we have multiple 01-levels
in a single file and we don&#8217;t (or can&#8217;t) use them as a single schema.</p>
<p>We may need to revise this function because we need a different lexer.
We might have some awful formatting issue with the source that needs to be
tweaked.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">COBOL_schemata</span><span class="p">(</span> <span class="n">source</span><span class="p">,</span> <span class="n">replacing</span><span class="o">=</span><span class="bp">None</span> <span class="p">):</span>
    <span class="n">lexer</span><span class="o">=</span> <span class="n">Lexer</span><span class="p">(</span> <span class="n">replacing</span> <span class="p">)</span>
    <span class="n">parser</span><span class="o">=</span> <span class="n">RecordFactory</span><span class="p">()</span>
    <span class="n">dde_list</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">parser</span><span class="o">.</span><span class="n">makeRecord</span><span class="p">(</span> <span class="n">lexer</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
    <span class="n">schema_list</span><span class="o">=</span> <span class="nb">list</span><span class="p">(</span> <span class="n">make_schema</span><span class="p">(</span> <span class="n">dde</span> <span class="p">)</span> <span class="k">for</span> <span class="n">dde</span> <span class="ow">in</span> <span class="n">dde_list</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">dde_list</span><span class="p">,</span> <span class="n">schema_list</span>
</pre></div>
</div>
<p>This gives us two API alternatives for parsing super-complex copybooks.</p>
<p>There&#8217;s a &#8220;Low-Level API&#8221; that looks like this:</p>
<p>There&#8217;s a &#8220;High-Level API&#8221; that looks like this:</p>
<p>When opening the workbook, one of the schema must be chosen as the &#8220;official&#8221; schema.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/Stingray_belon1553_small.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">10.2.2. COBOL Loader Module &#8211; Parse COBOL Source to Load a Schema</a><ul>
<li><a class="reference internal" href="#load-a-schema-use-case">10.2.2.1. Load A Schema Use Case</a></li>
<li><a class="reference internal" href="#use-a-schema-use-case">10.2.2.2. Use A Schema Use Case</a></li>
<li><a class="reference internal" href="#extensions-and-special-cases">10.2.2.3. Extensions and Special Cases</a></li>
<li><a class="reference internal" href="#design">10.2.2.4. Design</a><ul>
<li><a class="reference internal" href="#dde-class">10.2.2.4.1. DDE Class</a></li>
<li><a class="reference internal" href="#dde-post-processing">10.2.2.4.2. DDE Post-processing</a></li>
<li><a class="reference internal" href="#dde-parser">10.2.2.4.3. DDE Parser</a></li>
<li><a class="reference internal" href="#field-values">10.2.2.4.4. Field Values</a></li>
<li><a class="reference internal" href="#additional-requirements">10.2.2.4.5. Additional Requirements</a></li>
<li><a class="reference internal" href="#model">10.2.2.4.6. Model</a></li>
</ul>
</li>
<li><a class="reference internal" href="#overheads">10.2.2.5. Overheads</a></li>
<li><a class="reference internal" href="#parsing-exceptions">10.2.2.6. Parsing Exceptions</a></li>
<li><a class="reference internal" href="#picture-clause-parsing">10.2.2.7. Picture Clause Parsing</a></li>
<li><a class="reference internal" href="#lexical-scanning">10.2.2.8. Lexical Scanning</a></li>
<li><a class="reference internal" href="#parsing">10.2.2.9. Parsing</a></li>
<li><a class="reference internal" href="#cobol-schema-loader">10.2.2.10. COBOL Schema Loader</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="cobol_init.html"
                        title="previous chapter">10.2.1. COBOL Package &#8211; Extend Schema to Handle EBCDIC</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="cobol_defs.html"
                        title="next chapter">10.2.3. COBOL Definitions Module &#8211; Handle COBOL DDE&#8217;s</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/cobol_loader.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="cobol_defs.html" title="10.2.3. COBOL Definitions Module – Handle COBOL DDE’s"
             >next</a> |</li>
        <li class="right" >
          <a href="cobol_init.html" title="10.2.1. COBOL Package – Extend Schema to Handle EBCDIC"
             >previous</a> |</li>
        <li><a href="index.html">The Stingray Schema-Based File Reader</a> &raquo;</li>
          <li><a href="cobol.html" >10. The COBOL Package</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, S. Lott.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>